<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mosquito Acoustic Classifier</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        .card { box-shadow: 0 10px 15px rgba(0, 0, 0, 0.05); }
        .btn-primary { transition: all 0.2s; }
        .btn-primary:hover { opacity: 0.9; transform: translateY(-1px); }
        #status-display { white-space: pre-wrap; word-wrap: break-word; }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-lg bg-white p-6 md:p-8 rounded-xl card border border-gray-100">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-2">Mosquito Classifier</h1>
        <p class="text-center text-gray-500 mb-8">Identify potential malaria vectors from sound.</p>

        <!-- Main Content Grid -->
        <div class="space-y-6">

            <!-- Recording Section -->
            <div class="p-5 bg-indigo-50 rounded-lg border border-indigo-200">
                <h2 class="text-xl font-semibold text-indigo-800 mb-3">1. Record Audio</h2>
                <div class="flex flex-col space-y-3">
                    <button id="recordButton" class="btn-primary w-full py-3 rounded-lg text-white font-medium bg-indigo-600 hover:bg-indigo-700">
                        Start Recording
                    </button>
                    <!-- New Playback Button -->
                    <button id="playButton" class="w-full py-2 rounded-lg text-indigo-700 font-medium bg-indigo-200 hover:bg-indigo-300 disabled:opacity-50" disabled>
                        Play Last Recording
                    </button>
                    <div id="recordingStatus" class="text-center text-sm text-gray-600 font-mono">Ready</div>
                </div>
            </div>

            <!-- Upload Section -->
            <div class="p-5 bg-green-50 rounded-lg border border-green-200">
                <h2 class="text-xl font-semibold text-green-800 mb-3">2. Upload File</h2>
                <input type="file" id="audioFile" accept="audio/*" class="w-full text-sm text-gray-600
                    file:mr-4 file:py-2 file:px-4
                    file:rounded-full file:border-0
                    file:text-sm file:font-semibold
                    file:bg-green-100 file:text-green-700
                    hover:file:bg-green-200
                "/>
                <button id="uploadButton" class="btn-primary w-full mt-4 py-3 rounded-lg text-white font-medium bg-green-600 hover:bg-green-700" disabled>
                    Predict from File
                </button>
            </div>

            <!-- Results Section -->
            <div class="p-5 bg-white border border-gray-300 rounded-lg">
                <h2 class="text-xl font-semibold text-gray-800 mb-3">3. Prediction Result</h2>
                <pre id="status-display" class="bg-gray-100 p-4 rounded-lg text-sm text-gray-700 overflow-x-auto">Waiting for input...</pre>
                <div id="loadingIndicator" class="hidden text-center mt-3">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 inline-block"></div>
                    <p class="text-indigo-600 text-sm mt-1">Analyzing audio...</p>
                </div>
            </div>

        </div>
    </div>

    <script>
        // Global variables for recording
        let mediaRecorder;
        let audioChunks = [];
        let lastAudioBlobUrl = null; // New global variable for storing the audio URL

        const recordButton = document.getElementById('recordButton');
        const uploadButton = document.getElementById('uploadButton');
        const audioFile = document.getElementById('audioFile');
        const recordingStatus = document.getElementById('recordingStatus');
        const statusDisplay = document.getElementById('status-display');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const playButton = document.getElementById('playButton'); // New element

        // --- Utility Functions ---

        function displayMessage(message, isError = false) {
            statusDisplay.textContent = isError ? `ERROR: ${message}` : message;
            statusDisplay.className = isError 
                ? 'bg-red-100 p-4 rounded-lg text-sm text-red-700 overflow-x-auto'
                : 'bg-gray-100 p-4 rounded-lg text-sm text-gray-700 overflow-x-auto';
            loadingIndicator.classList.add('hidden');
        }

        function showLoading() {
            statusDisplay.textContent = 'Sending audio to server...';
            statusDisplay.className = 'bg-gray-100 p-4 rounded-lg text-sm text-gray-700 overflow-x-auto';
            loadingIndicator.classList.remove('hidden');
        }

        function formatResult(data) {
            const { species, probability, all_scores } = data.prediction;
            const scores = Object.entries(all_scores).map(([label, score]) => 
                `${label}: ${(score * 100).toFixed(2)}%`
            ).join('\n');
            
            return `--- PREDICTION COMPLETE ---\n\n` +
                   `Predicted Species: ${species.toUpperCase()}\n` +
                   `Confidence: ${(probability * 100).toFixed(2)}%\n\n` +
                   `All Scores:\n${scores}`;
        }
        
        /** Cleans up the previous recorded audio URL and disables the play button. */
        function cleanupLastRecording() {
             if (lastAudioBlobUrl) {
                URL.revokeObjectURL(lastAudioBlobUrl);
                lastAudioBlobUrl = null;
             }
             playButton.disabled = true;
        }

        // --- API Call Functions ---

        async function postPrediction(endpoint, payload, isFile = false) {
            showLoading();
            try {
                const url = endpoint === 'file' ? '/predict/file' : '/predict/base64';
                
                const fetchOptions = {
                    method: 'POST',
                    body: isFile ? payload : JSON.stringify(payload),
                };

                if (!isFile) {
                    fetchOptions.headers = { 'Content-Type': 'application/json' };
                }

                const response = await fetch(url, fetchOptions);

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Server returned status ${response.status} from endpoint ${url}: ${errorText}`);
                }

                const data = await response.json();
                displayMessage(formatResult(data));

            } catch (error) {
                console.error("Prediction Error:", error);
                displayMessage(`Failed to get prediction. Error: ${error.message}`, true);
            } finally {
                // Re-enable the button and reset status after prediction completes or fails
                if (recordButton.textContent === 'Processing...') {
                     recordButton.textContent = 'Start Recording';
                     recordButton.disabled = false;
                     recordingStatus.textContent = 'Ready';
                }
            }
        }

        // --- Recording Logic Refactored for Start/Stop Toggle ---
        
        async function startRecording() {
             // 1. Reset UI and cleanup old recording
            displayMessage('Initializing microphone...');
            recordButton.disabled = true;
            cleanupLastRecording();

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
                audioChunks = [];

                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = async () => {
                    recordingStatus.textContent = 'Processing...';
                    stream.getTracks().forEach(track => track.stop()); // Stop mic access

                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    
                    // --- ENABLE PLAYBACK ---
                    lastAudioBlobUrl = URL.createObjectURL(audioBlob);
                    playButton.disabled = false;
                    // --- END ENABLE PLAYBACK ---

                    // Convert Blob to Base64 (for prediction)
                    const reader = new FileReader();
                    reader.onloadend = async () => {
                        const base64Data = reader.result.split(',')[1]; 
                        await postPrediction('base64', { audio_base64: base64Data });
                        // Re-enabling logic is handled in postPrediction's finally block
                    };
                    reader.readAsDataURL(audioBlob);
                };

                mediaRecorder.start();
                recordButton.textContent = 'Stop Recording';
                recordButton.disabled = false;
                recordingStatus.textContent = 'Recording... Click Stop to analyze.';

            } catch (error) {
                console.error("Microphone access error:", error);
                displayMessage('Cannot access microphone. Ensure permissions are granted.', true);
                recordButton.disabled = false;
                recordingStatus.textContent = 'Ready';
                recordButton.textContent = 'Start Recording';
            }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                recordButton.disabled = true;
                recordButton.textContent = 'Processing...';
                recordingStatus.textContent = 'Stopping and preparing data...';
            }
        }
        
        // This is the main listener that toggles between Start and Stop
        recordButton.addEventListener('click', async () => {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                stopRecording();
            } else {
                await startRecording();
            }
        });
        
        // --- Play Button Logic ---
        playButton.addEventListener('click', () => {
            if (lastAudioBlobUrl) {
                const audio = new Audio(lastAudioBlobUrl);
                
                // Add temporary visual feedback while playing
                const originalText = playButton.textContent;
                playButton.textContent = 'Playing...';
                playButton.disabled = true; // Disable during playback
                
                audio.play().catch(e => {
                    console.error("Audio playback failed:", e);
                    displayMessage("Failed to play audio. Check browser media settings.", true);
                    playButton.disabled = false; // Re-enable on error
                    playButton.textContent = originalText;
                });
                
                audio.onended = () => {
                    playButton.disabled = false; // Re-enable after finished
                    playButton.textContent = originalText;
                };
            }
        });


        // --- File Upload Logic ---

        audioFile.addEventListener('change', () => {
            uploadButton.disabled = audioFile.files.length === 0;
            cleanupLastRecording(); // Cleanup recording URL if uploading a file
        });

        uploadButton.addEventListener('click', async () => {
            const file = audioFile.files[0];
            if (!file) {
                displayMessage('Please select an audio file first.', true);
                return;
            }

            uploadButton.disabled = true;
            const formData = new FormData();
            formData.append('audio_file', file);
            
            await postPrediction('file', formData, true);
            uploadButton.disabled = false;
        });

        // Initialize display
        window.onload = () => {
            displayMessage('Welcome! Use the buttons above to record or upload an audio file.');
        };

    </script>
</body>
</html>


